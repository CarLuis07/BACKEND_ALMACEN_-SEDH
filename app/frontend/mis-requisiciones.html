<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Requisiciones - SEDH</title>
    <style>
        :root {
            --sedh-primary: #0f766e;
            --sedh-secondary: #0f5e59;
            --sedh-bg: #f8f9fa;
            --sedh-success: #28a745;
            --sedh-warning: #ffc107;
            --sedh-danger: #dc3545;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0b3f3b 0%, #0f5e59 50%, #0f766e 100%);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, var(--sedh-primary) 0%, var(--sedh-secondary) 100%);
            color: white;
            padding: 35px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(15, 118, 110, 0.35);
        }
        .header h1 { font-size: 2.2rem; margin-bottom: 8px; }
        .header p { font-size: 1.1rem; opacity: 0.95; }
        .nav-link {
            background: white;
            color: var(--sedh-primary);
            padding: 12px 28px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: var(--sedh-primary);
            color: white;
            transform: translateY(-3px);
        }
        .requisiciones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        .requisicion-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.4s ease;
            border: 1px solid rgba(15, 118, 110, 0.08);
        }
        .requisicion-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 35px rgba(15, 118, 110, 0.25);
        }
        .card-header {
            background: linear-gradient(135deg, var(--sedh-primary) 0%, var(--sedh-secondary) 100%);
            color: white;
            padding: 18px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header .codigo { font-size: 1.3rem; font-weight: 700; }
        .badge { 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 600;
        }
        .badge-aprobado { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .badge-rechazado { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .badge-espera { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .card-body { padding: 24px; background: #f9fafb; }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        .info-row strong { color: var(--sedh-primary); font-weight: 600; }
        .section-title {
            font-weight: 700;
            font-size: 1.15rem;
            margin: 20px 0 12px 0;
            color: var(--sedh-primary);
            padding-left: 12px;
            border-left: 4px solid var(--sedh-primary);
        }
        .productos-table {
            width: 100%;
            margin-top: 12px;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .productos-table th {
            background: var(--sedh-primary);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
        }
        .productos-table td {
            padding: 12px 10px;
            font-size: 0.9rem;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }
        .flujo-aprobacion { 
            margin-top: 20px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }
        .flujo-step {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
        }
        .flujo-step.aprobado { border-left-color: #28a745; background: #f0fff4; }
        .flujo-step.rechazado { border-left-color: #dc3545; background: #fff5f5; }
        .flujo-step.pendiente { border-left-color: #ffc107; background: #fffbf0; }
        .flujo-title { font-weight: 600; color: #333; font-size: 0.95rem; }
        .flujo-status { font-size: 0.85rem; color: #666; }
        .flujo-obs { 
            font-size: 0.8rem; 
            color: #555; 
            background: rgba(255,255,255,0.7); 
            padding: 6px 10px; 
            border-radius: 6px;
            border-left: 2px solid #0f766e;
            margin-top: 5px;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .loading { text-align: center; padding: 40px; }
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--sedh-primary);
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.12);
        }
        .filters-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .filter-btn.active {
            background: var(--sedh-primary);
            color: white;
            border-color: var(--sedh-primary);
        }
        .btn-pdf {
            background: #dc3545;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 12px;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
        }
        .btn-pdf:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Mis Requisiciones</h1>
            <p>Seguimiento de mis solicitudes</p>
        </div>
        <a href="/dashboard" class="nav-link">üîô Volver</a>
        
        <div class="filters-bar">
            <button class="filter-btn active" data-filter="TODOS" onclick="aplicarFiltroEstado('TODOS')">
                ‚úÖ Todos
            </button>
            <button class="filter-btn" data-filter="APROBADO" onclick="aplicarFiltroEstado('APROBADO')">
                ‚úîÔ∏è Aprobados
            </button>
            <button class="filter-btn" data-filter="EN ESPERA" onclick="aplicarFiltroEstado('EN ESPERA')">
                ‚è≥ En Espera
            </button>
            <button class="filter-btn" data-filter="RECHAZADO" onclick="aplicarFiltroEstado('RECHAZADO')">
                ‚ùå Rechazados
            </button>
        </div>
        
        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="üîç Buscar por c√≥digo de requisici√≥n (ej: UIT-019-2025)..."
                autocomplete="off"
            >
        </div>
        
        <div id="requisiciones-container"><div class="loading">Cargando requisiciones...</div></div>
    </div>
    <script>
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api/v1`;
        let todasLasRequisiciones = [];
        let filtroEstadoActual = 'TODOS';
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!localStorage.getItem('token')) { window.location.href = '/login'; return; }
            await cargarRequisiciones();
            document.getElementById('searchInput').addEventListener('input', filtrarRequisiciones);
        });
        
        function aplicarFiltroEstado(estado) {
            filtroEstadoActual = estado;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-filter="${estado}"]`).classList.add('active');
            filtrarRequisiciones();
        }
        
        function filtrarRequisiciones() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            let filtradas = todasLasRequisiciones;
            
            if (filtroEstadoActual !== 'TODOS') {
                filtradas = filtradas.filter(req => req.EstGeneral === filtroEstadoActual);
            }
            
            if (searchTerm) {
                filtradas = filtradas.filter(req => req.CodRequisicion.toLowerCase().includes(searchTerm));
            }
            
            renderizarRequisiciones(filtradas);
        }
        
        async function cargarRequisiciones() {
            const container = document.getElementById('requisiciones-container');
            try {
                const response = await fetch(`${API_BASE_URL}/requisiciones/mis-requisiciones`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (!response.ok) throw new Error(`Error ${response.status}`);
                
                todasLasRequisiciones = await response.json();
                renderizarRequisiciones(todasLasRequisiciones);
            } catch (error) {
                container.innerHTML = `<div class="loading" style="color: red;">Error: ${error.message}</div>`;
            }
        }
        
        function renderizarRequisiciones(requisiciones) {
            const container = document.getElementById('requisiciones-container');
            if (requisiciones.length === 0) {
                container.innerHTML = '<div class="loading">No hay requisiciones</div>';
                return;
            }
            
            container.innerHTML = `<div class="requisiciones-grid">${requisiciones.map(req => `
                    <div class="requisicion-card">
                        <div class="card-header">
                            <div class="codigo">üìù ${req.CodRequisicion}</div>
                            <div class="badge badge-${req.EstGeneral === 'APROBADO' ? 'aprobado' : req.EstGeneral === 'RECHAZADO' ? 'rechazado' : 'espera'}">
                                ${req.EstGeneral === 'APROBADO' ? '‚úÖ APROBADO' : req.EstGeneral === 'RECHAZADO' ? '‚ùå RECHAZADO' : '‚è≥ EN ESPERA'}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="section-title">‚è∞ Control de Tiempos</div>
                            <div class="info-row"><strong>üìÖ Creada:</strong><span>${req.ControlTiempos?.Creacion ? new Date(req.ControlTiempos.Creacion).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'}) : 'N/A'}</span></div>
                            <div class="info-row"><strong>üì§ Enviada:</strong><span>${req.ControlTiempos?.Envio ? new Date(req.ControlTiempos.Envio).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'}) : 'N/A'}</span></div>
                            
                            <div class="section-title">üìå Informaci√≥n General</div>
                            <div class="info-row"><strong>üë§ Empleado:</strong><span>${req.NomEmpleado || 'N/A'}</span></div>
                            <div class="info-row"><strong>üìÖ Fecha:</strong><span>${new Date(req.FecSolicitud).toLocaleDateString('es-HN')}</span></div>
                            <div class="info-row"><strong>üí∞ Total:</strong><span>L. ${Number(req.GasTotalDelPedido || 0).toFixed(2)}</span></div>
                            ${req.CodPrograma ? `<div class="info-row"><strong>üìä Programa:</strong><span>${req.CodPrograma}</span></div>` : ''}
                            
                            ${req.ObsEmpleado ? `<div class="section-title">üìù Observaciones del Empleado</div>
                            <div class="info-row" style="grid-template-columns: 1fr;"><p style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin: 0;">${req.ObsEmpleado}</p></div>` : ''}
                            
                            <div class="section-title">üîÑ Flujo de Aprobaci√≥n</div>
                            ${req.AprobadorActualRol && req.AprobadorActualNombre ? `<div class="info-row"><strong>‚û°Ô∏è Ahora:</strong><span>${req.AprobadorActualRol} ‚Äî ${req.AprobadorActualNombre}</span></div>` : ''}
                            <div class="flujo-aprobacion">
                                <div class="flujo-step ${getEstadoClase(req.FlujoAprobacion?.JefeInmediato)}">
                                    <div class="flujo-title">üë®‚Äçüíº Jefe Inmediato</div>
                                    <div class="flujo-status">${req.FlujoAprobacion?.JefeInmediato || 'Pendiente'}${(req.FlujoAprobacion?.JefeInmediato === 'Pendiente' && (req.NombreJefeInmediato)) ? ` ‚Äî ${req.NombreJefeInmediato}` : ''}</div>
                                    ${req.DetalleAprobaciones?.JefeInmediato?.NombreAprobador ? `<div class='flujo-obs'>‚úÖ Aprobado por: ${req.DetalleAprobaciones.JefeInmediato.NombreAprobador}</div>` : ''}
                                    ${req.DetalleAprobaciones?.JefeInmediato?.FechaAprobacion ? `<div class='flujo-obs'>üïí ${new Date(req.DetalleAprobaciones.JefeInmediato.FechaAprobacion).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'})}</div>` : ''}
                                    ${req.ObsJefeInmediato ? `<div class="flujo-obs">üí¨ ${req.ObsJefeInmediato}</div>` : ''}
                                </div>
                                <div class="flujo-step ${getEstadoClase(req.FlujoAprobacion?.GerenteAdministrativo)}">
                                    <div class="flujo-title">üè¢ Gerente Admin.</div>
                                    <div class="flujo-status">${req.FlujoAprobacion?.GerenteAdministrativo || 'Pendiente'}${(req.FlujoAprobacion?.GerenteAdministrativo === 'Pendiente' && req.ListaGerentesAdmin) ? ` ‚Äî ${req.ListaGerentesAdmin.split(',')[0]}` : ''}</div>
                                    ${req.DetalleAprobaciones?.GerenteAdministrativo?.NombreAprobador ? `<div class='flujo-obs'>‚úÖ Aprobado por: ${req.DetalleAprobaciones.GerenteAdministrativo.NombreAprobador}</div>` : ''}
                                    ${req.DetalleAprobaciones?.GerenteAdministrativo?.FechaAprobacion ? `<div class='flujo-obs'>üïí ${new Date(req.DetalleAprobaciones.GerenteAdministrativo.FechaAprobacion).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'})}</div>` : ''}
                                </div>
                                <div class="flujo-step ${getEstadoClase(req.FlujoAprobacion?.JefeServiciosMateriales)}">
                                    <div class="flujo-title">üì¶ Jefe Materiales</div>
                                    <div class="flujo-status">${req.FlujoAprobacion?.JefeServiciosMateriales || 'Pendiente'}${(req.FlujoAprobacion?.JefeServiciosMateriales === 'Pendiente' && req.ListaJefeMateriales) ? ` ‚Äî ${req.ListaJefeMateriales.split(',')[0]}` : ''}</div>
                                    ${req.DetalleAprobaciones?.JefeServiciosMateriales?.NombreAprobador ? `<div class='flujo-obs'>‚úÖ Aprobado por: ${req.DetalleAprobaciones.JefeServiciosMateriales.NombreAprobador}</div>` : ''}
                                    ${req.DetalleAprobaciones?.JefeServiciosMateriales?.FechaAprobacion ? `<div class='flujo-obs'>üïí ${new Date(req.DetalleAprobaciones.JefeServiciosMateriales.FechaAprobacion).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'})}</div>` : ''}
                                    ${req.ObsJefeMateriales ? `<div class="flujo-obs">üí¨ ${req.ObsJefeMateriales}</div>` : ''}
                                </div>
                                <div class="flujo-step ${getEstadoClase(req.FlujoAprobacion?.Almacen)}">
                                    <div class="flujo-title">üè™ Almac√©n</div>
                                    <div class="flujo-status">${req.FlujoAprobacion?.Almacen || 'Pendiente'}${(req.FlujoAprobacion?.Almacen === 'Pendiente' && req.ListaAlmacen) ? ` ‚Äî ${req.ListaAlmacen.split(',')[0]}` : ''}</div>
                                    ${req.DetalleAprobaciones?.Almacen?.NombreAprobador ? `<div class='flujo-obs'>‚úÖ Aprobado por: ${req.DetalleAprobaciones.Almacen.NombreAprobador}</div>` : ''}
                                    ${req.DetalleAprobaciones?.Almacen?.FechaAprobacion ? `<div class='flujo-obs'>üïí ${new Date(req.DetalleAprobaciones.Almacen.FechaAprobacion).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'})}</div>` : ''}
                                    ${req.ObsAlmacen ? `<div class="flujo-obs">üí¨ ${req.ObsAlmacen}</div>` : ''}
                                </div>
                                ${(req.ControlTiempos && req.ControlTiempos.Rechazo) ? `<div class='flujo-step rechazado'><div class='flujo-title'>‚ùå Rechazo</div><div class='flujo-obs'>üïí ${new Date(req.ControlTiempos.Rechazo).toLocaleString('es-HN', {dateStyle: 'short', timeStyle: 'short'})}</div></div>` : ''}
                            </div>
                            
                            <div class="section-title">üì¶ Productos (${req.TotalProductos || 0})</div>
                            ${req.Productos && req.Productos.length > 0 ? `
                                <table class="productos-table">
                                    <thead><tr><th>üì¶ Producto</th><th>üî¢ Qty</th><th>üíµ Precio</th></tr></thead>
                                    <tbody>${req.Productos.map(p => `
                                        <tr>
                                            <td><strong>${p.NomProducto}</strong></td>
                                            <td>${p.Cantidad}</td>
                                            <td>L. ${Number(p.PrecioUnitario || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}</tbody>
                                </table>
                            ` : '<p style="color:#999;">üì≠ Sin productos</p>'}
                            
                            ${req.EstGeneral === 'APROBADO' ? `
                                <button class="btn-pdf" onclick="descargarPDFRequisicion('${req.IdRequisicion}', '${req.CodRequisicion}')">
                                    üìÑ Descargar PDF
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}</div>`;
                // Formatear fecha/hora en espa√±ol
                function formatFechaHora(fechaIso) {
                    if (!fechaIso) return '';
                    const fecha = new Date(fechaIso);
                    return fecha.toLocaleString('es-HN');
                }
        }
        
        function getEstadoClase(estado) {
            if (estado === 'Aprobado') return 'aprobado';
            if (estado === 'Rechazado') return 'rechazado';
            return 'pendiente';
        }
        
        function descargarPDFRequisicion(idRequisicion, codigoRequisicion) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('No hay sesi√≥n activa. Por favor, inicie sesi√≥n.');
                window.location.href = '/login';
                return;
            }
            
            const url = `${API_BASE_URL}/requisiciones/${encodeURIComponent(idRequisicion)}/pdf`;
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }
                return response.blob();
            })
            .then(blob => {
                const urlBlob = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = urlBlob;
                link.download = `requisicion-${codigoRequisicion}.pdf`;
                document.body.appendChild(link);
                link.click();
                window.URL.revokeObjectURL(urlBlob);
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error('Error descargando PDF:', error);
                alert('No se pudo descargar el PDF de la requisici√≥n');
            });
        }
    </script>
</body>
</html>
